<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registrar Factura | FACT-3000</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
<script src="https://kit.fontawesome.com/a2e0a4c6b6.js" crossorigin="anonymous"></script>
<style>
body { background-color: #f8f9fa; }
h2 { text-align: center; margin-bottom: 30px; }
.form-container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
.total-final { font-size: 1.2rem; font-weight: bold; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
<a class="navbar-brand font-weight-bold" href="index.html"><i class="fas fa-file-invoice"></i> FACT-3000</a>
<ul class="navbar-nav ml-auto">
<li class="nav-item"><a class="nav-link" href="lista_facturas.html"><i class="fas fa-list"></i> Ver Facturas</a></li>
</ul>
</nav>

<div class="container mt-5">
<div class="form-container mx-auto col-md-8">
<h2>Registrar Factura</h2>
<form id="formularioFactura">

    <div class="form-group">
        <label for="cliente">Cliente</label>
        <select class="form-control" id="cliente" required></select>
    </div>

    <div class="form-group">
        <label>Productos</label>
        <div class="input-group mb-2">
            <select class="form-control" id="productoSelect"></select>
            <input type="number" class="form-control" id="cantidadInput" placeholder="Cantidad" min="1" value="1">
            <div class="input-group-append">
                <button class="btn btn-success" type="button" id="agregarProducto">Agregar</button>
            </div>
        </div>

        <table class="table table-bordered" id="tablaProductos">
            <thead class="thead-light">
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="form-group text-right total-final">
        Total: $<span id="totalFactura">0.00</span>
    </div>

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save"></i> Registrar Factura</button>
        <a href="lista_facturas.html" class="btn btn-secondary px-4 ml-2"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>

</form>
</div>
</div>

<script>
let productosFactura = [];

// Inicialización
document.addEventListener("DOMContentLoaded", function() {
    cargarClientes();
    cargarProductos();
    document.getElementById("agregarProducto").addEventListener("click", agregarProductoTabla);
    document.getElementById("formularioFactura").addEventListener("submit", guardarFactura);
});

// Cargar clientes desde localStorage
function cargarClientes() {
    const clientes = JSON.parse(localStorage.getItem("clientes")) || [];
    const select = document.getElementById("cliente");
    select.innerHTML = clientes.length === 0 ? `<option value="">No hay clientes</option>` : `<option value="">Seleccione un cliente</option>`;
    clientes.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`);
}

// Cargar productos desde localStorage
function cargarProductos() {
    const productos = JSON.parse(localStorage.getItem("productos")) || [];
    const select = document.getElementById("productoSelect");
    select.innerHTML = productos.length === 0 ? `<option value="">No hay productos</option>` : `<option value="">Seleccione un producto</option>`;
    productos.forEach(p => select.innerHTML += `<option value="${p.id}" data-precio="${p.precio}">${p.nombre} - $${p.precio}</option>`);
}

// Agregar producto a la tabla
function agregarProductoTabla() {
    const productoSelect = document.getElementById("productoSelect");
    const cantidad = parseInt(document.getElementById("cantidadInput").value) || 1;
    if(!productoSelect.value) return alert("Seleccione un producto válido");

    const id = productoSelect.value;
    const nombre = productoSelect.selectedOptions[0].textContent.split(" - $")[0];
    const precio = parseFloat(productoSelect.selectedOptions[0].dataset.precio);
    const subtotal = precio * cantidad;

    productosFactura.push({id, nombre, precio, cantidad, subtotal});
    renderizarTabla();
}

// Renderizar tabla de productos
function renderizarTabla() {
    const tbody = document.querySelector("#tablaProductos tbody");
    tbody.innerHTML = "";
    let total = 0;

    productosFactura.forEach((p,i) => {
        total += p.subtotal;
        tbody.innerHTML += `
            <tr>
                <td>${p.nombre}</td>
                <td>${p.cantidad}</td>
                <td>$${p.precio.toFixed(2)}</td>
                <td>$${p.subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">Eliminar</button></td>
            </tr>
        `;
    });

    document.getElementById("totalFactura").textContent = total.toFixed(2);
}

// Eliminar producto de la tabla
function eliminarProducto(index) {
    productosFactura.splice(index, 1);
    renderizarTabla();
}

// Guardar factura
function guardarFactura(e) {
    e.preventDefault();

    const clienteId = document.getElementById("cliente").value;
    if(!clienteId) return alert("Seleccione un cliente.");
    if(productosFactura.length === 0) return alert("Agregue al menos un producto.");

    const clientes = JSON.parse(localStorage.getItem("clientes")) || [];
    const cliente = clientes.find(c => c.id == clienteId);

    const facturas = JSON.parse(localStorage.getItem("facturas")) || [];
    const nuevaFactura = {
        id: Date.now(),
        clienteId: cliente.id,
        clienteNombre: cliente.nombre,
        productos: productosFactura,
        total: productosFactura.reduce((sum,p)=>sum+p.subtotal,0),
        fecha: new Date().toLocaleDateString(),
        estado: "Pendiente"
    };

    // Guardar en localStorage
    facturas.push(nuevaFactura);
    localStorage.setItem("facturas", JSON.stringify(facturas));

    alert("✅ Factura registrada correctamente.");
    window.location.href = "lista_facturas.html";
}
</script>
</body>
</html>






